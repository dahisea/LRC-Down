name: Download Lyrics

on:
  workflow_dispatch:
    inputs:
      max_retries:
        description: 'Maximum number of retries'
        required: false
        default: '3'
        type: string
      rate_limit_delay:
        description: 'Delay between requests (seconds)'
        required: false
        default: '0.5'
        type: string
      timeout_minutes:
        description: 'Workflow timeout (minutes)'
        required: false
        default: '30'
        type: string
  
  schedule:
    # æ¯å¤© UTC 00:00 è‡ªåŠ¨è¿è¡Œï¼ˆå¯é€‰ï¼‰
    - cron: '0 0 * * *'

jobs:
  download-lyrics:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout_minutes || '30') }}
    
    steps: 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Configure Cloudflare WARP
      uses: Boostport/setup-cloudflare-warp@v1
      with: 
        organization: ${{ secrets.CLOUDFLARE_ORGANIZATION }}
        auth_client_id: ${{ secrets.CLOUDFLARE_AUTH_CLIENT_ID }}
        auth_client_secret: ${{ secrets.CLOUDFLARE_AUTH_CLIENT_SECRET }}
      continue-on-error: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests urllib3

    - name: Create lyrics directory
      run: mkdir -p lyrics

    - name: Download lyrics
      env:
        LYRICS_API_URL: ${{ secrets.API }}
        MAX_RETRIES: ${{ github.event.inputs.max_retries || '3' }}
        RETRY_BACKOFF: '1.0'
        REQUEST_TIMEOUT: '30'
        RATE_LIMIT_DELAY: ${{ github.event.inputs.rate_limit_delay || '0.5' }}
        LYRICS_DIR: 'lyrics'
        MAX_FILENAME_LENGTH: '105'
      run: python run.py
      continue-on-error: false

    - name: Check download results
      id: check_results
      run: |
        LYRIC_COUNT=$(find lyrics -type f -name "*.lrc" 2>/dev/null | wc -l)
        echo "lyric_count=$LYRIC_COUNT" >> $GITHUB_OUTPUT
        
        # ç»Ÿè®¡æ–‡ä»¶å¤§å°
        TOTAL_SIZE=$(du -sh lyrics 2>/dev/null | cut -f1)
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Downloaded $LYRIC_COUNT lyrics files ($TOTAL_SIZE)"
        
        if [ $LYRIC_COUNT -eq 0 ]; then
          echo "âš ï¸ Warning: No lyrics files were downloaded"
          exit 1
        fi

    - name: Generate download report
      if: always()
      run: |
        echo "# ğŸ“Š Download Report" > report.md
        echo "" >> report.md
        echo "| Item | Value |" >> report.md
        echo "|------|-------|" >> report.md
        echo "| Workflow Run | #${{ github.run_number }} |" >> report.md
        echo "| Triggered By | ${{ github.event_name }} |" >> report.md
        echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> report.md
        echo "| Total Lyrics | ${{ steps.check_results.outputs.lyric_count }} |" >> report.md
        echo "| Total Size | ${{ steps.check_results.outputs.total_size }} |" >> report.md
        echo "" >> report.md
        
        # æ·»åŠ æ–‡ä»¶åˆ—è¡¨ï¼ˆå‰20ä¸ªï¼‰
        if [ -d lyrics ] && [ "$(ls -A lyrics)" ]; then
          echo "## ğŸ“ Downloaded Files (First 20)" >> report.md
          echo '```' >> report.md
          ls -lh lyrics/*.lrc 2>/dev/null | head -20 >> report.md
          echo '```' >> report.md
          echo "" >> report.md
        fi
        
        # æ·»åŠ æ—¥å¿—æ‘˜è¦
        if [ -f lyrics_downloader.log ]; then
          echo "## ğŸ“‹ Log Summary (Last 50 Lines)" >> report.md
          echo '```' >> report.md
          tail -n 50 lyrics_downloader.log >> report.md
          echo '```' >> report.md
        fi
        
        cat report.md

    - name: Archive lyrics files
      if: steps.check_results.outputs.lyric_count > 0
      run: |
        TIMESTAMP=$(date -u '+%Y%m%d_%H%M%S')
        ARCHIVE_NAME="lyrics_${TIMESTAMP}.zip"
        
        # åˆ›å»ºå‹ç¼©åŒ…ï¼Œæ’é™¤æ—¥å¿—æ–‡ä»¶
        cd lyrics
        zip -r ../$ARCHIVE_NAME . -x "*.log" "*.tmp"
        cd ..
        
        # è®¡ç®—å‹ç¼©åŒ… SHA256
        SHA256=$(sha256sum $ARCHIVE_NAME | cut -d' ' -f1)
        echo "$SHA256  $ARCHIVE_NAME" > ${ARCHIVE_NAME}.sha256
        
        echo "ğŸ“¦ Created archive: $ARCHIVE_NAME"
        echo "ğŸ” SHA256: $SHA256"
        ls -lh $ARCHIVE_NAME

    - name: Upload lyrics artifact
      if: steps.check_results.outputs.lyric_count > 0
      uses: actions/upload-artifact@v4
      with:
        name: lyrics-${{ github.run_number }}
        path: |
          lyrics_*.zip
          lyrics_*.sha256
          report.md
        retention-days: 30
        compression-level: 9
        if-no-files-found: warn

    - name: Upload lyrics directory
      if: steps.check_results.outputs.lyric_count > 0
      uses: actions/upload-artifact@v4
      with:
        name: lyrics-raw-${{ github.run_number }}
        path: lyrics/
        retention-days: 7
        if-no-files-found: warn

    - name: Upload log file
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.run_number }}
        path: |
          lyrics_downloader.log
          api_response_*.json
        retention-days: 7
        if-no-files-found: ignore

    - name: Cleanup old artifacts
      uses: actions/github-script@v7
      if: success()
      with:
        script: |
          const daysToKeep = 30;
          const maxArtifacts = 10;
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
          
          try {
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // æŒ‰ç±»å‹åˆ†ç»„
            const lyricsArtifacts = artifacts.data.artifacts
              .filter(a => a.name.startsWith('lyrics-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            const logsArtifacts = artifacts.data.artifacts
              .filter(a => a.name.startsWith('logs-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // åˆ é™¤è¶…è¿‡ä¿ç•™æ•°é‡çš„ artifacts
            for (const [type, list] of [['lyrics', lyricsArtifacts], ['logs', logsArtifacts]]) {
              for (let i = maxArtifacts; i < list.length; i++) {
                const artifact = list[i];
                const createdAt = new Date(artifact.created_at);
                
                if (createdAt < cutoffDate) {
                  console.log(`Deleting old ${type} artifact: ${artifact.name} (created: ${artifact.created_at})`);
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      artifact_id: artifact.id,
                    });
                  } catch (error) {
                    console.error(`Failed to delete artifact ${artifact.name}: ${error.message}`);
                  }
                }
              }
            }
            
            console.log(`âœ“ Cleanup completed`);
          } catch (error) {
            console.error(`Cleanup failed: ${error.message}`);
          }
      continue-on-error: true

    - name: Generate workflow summary
      if: always()
      run: |
        echo "## ğŸµ Lyrics Download Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # çŠ¶æ€å¾½ç« 
        if [ "${{ job.status }}" == "success" ]; then
          echo "![Status](https://img.shields.io/badge/Status-Success-brightgreen)" >> $GITHUB_STEP_SUMMARY
        else
          echo "![Status](https://img.shields.io/badge/Status-Failed-red)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # åŸºæœ¬ä¿¡æ¯
        echo "### ğŸ“‹ Basic Information" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered By | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Files | ${{ steps.check_results.outputs.lyric_count }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Size | ${{ steps.check_results.outputs.total_size }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # é…ç½®ä¿¡æ¯
        echo "### âš™ï¸ Configuration" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Max Retries | ${{ github.event.inputs.max_retries || '3' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Rate Limit | ${{ github.event.inputs.rate_limit_delay || '0.5' }}s |" >> $GITHUB_STEP_SUMMARY
        echo "| Timeout | ${{ github.event.inputs.timeout_minutes || '30' }}min |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ·»åŠ å®Œæ•´æŠ¥å‘Š
        if [ -f report.md ]; then
          echo "### ğŸ“Š Detailed Report" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY
        fi
        
        # ä¸‹è½½é“¾æ¥
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ Downloads" >> $GITHUB_STEP_SUMMARY
        echo "Artifacts are available in the workflow run artifacts section above." >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      run: |
        echo "::error::Lyrics download workflow failed. Check the logs for details."
        
        if [ -f lyrics_downloader.log ]; then
          echo "::group::Last 20 log lines"
          tail -n 20 lyrics_downloader.log
          echo "::endgroup::"
        fi